name: Keep Render Alive (jittered)

on:
  schedule:
    # UTC times: run every 3 minutes starting at :30 ‚Üí :30, :33, :36, :39, :42, :45, :48
    - cron: "30-48/3 * * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Decide if this tick is the chosen one
        id: gate
        shell: bash
        run: |
          # Current UTC hour (YYYYMMDDHH) as a key
          key="$(date -u +%Y%m%d%H)"
          # Hash the key ‚Üí first 8 hex chars
          hash=$(echo -n "$key" | sha256sum | cut -c1-8)
          # Convert hex to integer (bash supports 16# notation)
          num=$((16#$hash))
          # Pick index 0..6
          idx=$(( num % 7 ))

          # Map indices 0..6 to our tick minutes
          slots=(30 33 36 39 42 45 48)
          chosen="${slots[$idx]}"

          # Current minute (remove leading zero)
          now_min="$(date -u +%M | sed 's/^0*//')"
          now_min="${now_min:-0}"

          echo "Chosen minute this hour: $chosen"
          echo "Now minute: $now_min"

          if [ "$now_min" = "$chosen" ]; then
            echo "fire=true" >> $GITHUB_OUTPUT
          else
            echo "fire=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if not the chosen tick
        if: steps.gate.outputs.fire != 'true'
        run: echo "Skipping this tick."

      - name: Wake up Render service
        if: steps.gate.outputs.fire == 'true'
        run: |
          echo "üöÄ Attempting to wake Render service at $(date -u)"
          
          # Try with exact mobile browser headers that worked for you
          timeout=60  # Back to shorter timeout since it should be instant if it works
          
          echo "Making request with mobile browser headers..."
          start_time=$(date +%s)
          
          response=$(curl -sS --max-time $timeout \
               -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8" \
               -H "Accept-Language: en-US,en;q=0.9" \
               -H "Accept-Encoding: gzip, deflate, br" \
               -H "DNT: 1" \
               -H "Connection: keep-alive" \
               -H "Upgrade-Insecure-Requests: 1" \
               -A "Mozilla/5.0 (Linux; Android 10; SM-G973F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.120 Mobile Safari/537.36" \
               -w "\nHTTP_CODE:%{http_code}\nTIME_TOTAL:%{time_total}" \
               "https://dydx-client-web.onrender.com/" 2>&1)
          
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          
          echo "=== Results after ${duration}s ==="
          echo "$response" | tail -5
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          time_total=$(echo "$response" | grep "TIME_TOTAL:" | cut -d: -f2)
          
          if [[ "$http_code" =~ ^[23] ]]; then
            echo "‚úÖ SUCCESS! Service responded with HTTP $http_code in ${time_total}s"
            echo "üéâ This should now appear in your Render logs!"
          else
            echo "‚ùå Still not working: HTTP $http_code"
            echo "Render may be blocking GitHub Actions IPs or detecting automation"
          fi
          
          exit 0