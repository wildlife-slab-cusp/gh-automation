name: Keep Render Alive (query params)

on:
  schedule:
    # Runs every 10 minutes
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    concurrency:
      group: keep-render-alive
      cancel-in-progress: true

    steps:
      - name: Wake Render service
        run: |
          echo "ðŸš€ Pinging Render at $(date -u)"

          base_url="${{ secrets.RENDER_SERVICE_URL }}"

          # Rotate User-Agent strings
          agents=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0 Safari/537.36"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15"
            "Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1"
          )
          ua=${agents[$RANDOM % ${#agents[@]}]}

          # Randomized delay before request
          sleep $((RANDOM % 5))

          echo "1. GET / (homepage)"
          http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 \
               -H "Accept: text/html,application/xhtml+xml" \
               -H "Accept-Language: en-US,en;q=0.9" \
               -H "Sec-Fetch-Site: none" \
               -H "Sec-Fetch-Mode: navigate" \
               -H "Sec-Fetch-User: ?1" \
               -H "Sec-Fetch-Dest: document" \
               -H "Referer: https://google.com/" \
               -A "$ua" \
               "$base_url/?Render=data")

          if [ "$http_code" -eq 503 ]; then
            echo "ðŸš¨ Render service returned a 503 Service Unavailable error! HTTP Status: $http_code"
            exit 1 # Fail the job
          else
            echo "âœ… Stealth ping completed. HTTP Status: $http_code"
          fi